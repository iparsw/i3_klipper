# This file contains common pin mappings for the BigTreeTech SKR PRO.
# To use this config, the firmware should be compiled for the
# STM32F407 with a "32KiB bootloader".

# The "make flash" command does not work on the SKR PRO. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR PRO
# with that SD card.

# See docs/Config_Reference.md for a description of parameters.



####################################################################################
#INCLUDES

# include mainsail specific settings
[include mainsail.cfg]
# include my macros
[include Macros.cfg]

####################################################################################
# mcu specific settings


[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_29001C001147323137363638-if00
baud: 250000



########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PG4, EXP1_3=PD11, EXP1_5=PG2, EXP1_7=PG6, EXP1_9=<GND>,
    EXP1_2=PA8, EXP1_4=PD10, EXP1_6=PG3, EXP1_8=PG7, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PB14, EXP2_3=PG10, EXP2_5=PF11, EXP2_7=PF12,  EXP2_9=<GND>,
    EXP2_2=PB13, EXP2_4=PB12, EXP2_6=PB15, EXP2_8=<RST>, EXP2_10=PF13
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "spi2"

# See the sample-lcd.cfg file for definitions of common LCD displays.




[display]
lcd_type: hd44780
rs_pin: EXP1_4
e_pin: EXP1_3
d4_pin: EXP1_5
d5_pin: EXP1_6
d6_pin: EXP1_7
d7_pin: EXP1_8
encoder_pins: ^EXP2_3, ^EXP2_5
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8


[output_pin beeper]
pin: EXP1_1


####################################################################################
# BTT PI AS MCU 


[mcu host]
serial: /tmp/klipper_host_mcu


# BTT PI FAN
[temperature_fan raspberry_pi]
pin: host:gpio211
kick_start_time: 0.8
#shutdown_speed: 0
off_below: 0.1
max_power: 1.0
#fan_speed: 0.6
sensor_type: temperature_host
control: pid
min_temp: 0
max_temp: 85
#max_delta: 5.0
pid_kp: 1.0
pid_ki: 0.5
pid_kd: 2.0
min_speed: 0.1
max_speed: 0.6
target_temp: 25




####################################################################################
# kinematic

[printer]
kinematics: cartesian
max_velocity: 800
max_accel: 6500
max_z_velocity: 8
max_z_accel: 100
square_corner_velocity: 5.0





####################################################################################
# Steppers


# X AXIS

[stepper_x]
step_pin: PE9
dir_pin: !PF1              #Iparsw I3 X is reversed
enable_pin: !PF2
microsteps: 32
full_steps_per_rotation: 200
rotation_distance: 32
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: -14
position_max: 224
position_min: -14
homing_speed: 50
homing_retract_dist: 0 # one shot homing


[tmc2209 stepper_x]
uart_pin: PC13
#tx_pin: PE4
interpolate: False
stealthchop_threshold: 100
run_current: 0.800
diag_pin: PB10
driver_SGTHRS: 130 # sensorless homing sensivity


# Y AXIS

[stepper_y]
step_pin: PE11
dir_pin: PE8
enable_pin: !PD7
microsteps: 32
full_steps_per_rotation: 200
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 0
position_max: 207
position_min: 0
homing_speed: 50
homing_retract_dist: 0 # one shot homing


[tmc2209 stepper_y]
uart_pin: PE3
#tx_pin: PE2
interpolate: False
stealthchop_threshold: 100
run_current: 1.000
diag_pin: PE12
driver_SGTHRS: 110 # sensorless homing sensivity


# Z AXIS 0

[stepper_z]
step_pin: PE13
dir_pin: !PC2              #Iparsw I3 Z is reversed
enable_pin: !PC0
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2
endstop_pin: probe:z_virtual_endstop
position_min: -1.0
position_max: 170


[tmc2208 stepper_z]
uart_pin: PE1
run_current: 0.800
stealthchop_threshold: 999999


# Z AXIS 1

[stepper_z1]
step_pin: PD13
dir_pin: !PG9              #Iparsw I3 Z2 is reversed
enable_pin: !PF0
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 2
endstop_pin: probe:z_virtual_endstop


[tmc2208 stepper_z1]
uart_pin: PD6
run_current: 0.800
stealthchop_threshold: 999999




####################################################################################
# EXTRUDER


[extruder]
step_pin: PE14
dir_pin: PA0
enable_pin: !PC3
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 26.8

# ! NOZZLE DIAMETER
nozzle_diameter: 0.600
filament_diameter: 1.750

# ADVANCE 
# max_extrude_cross_section:  4.0 * nozzle_diameter^2
instantaneous_corner_velocity: 1.000

# PRESSURE ADVANCE
pressure_advance: 0.0
pressure_advance_smooth_time: 0.040

# THERMAL
heater_pin:  PB1   # Heat0
sensor_pin:  PF4   # T1 Header
sensor_type: Generic 3950
smooth_time: 1.0
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
min_temp: 15
max_temp: 260
min_extrude_temp: 170 # MIN EXTRUDE TEMP


[tmc2209 extruder]
uart_pin: PD4
tx_pin: PD2
interpolate: False
run_current: 0.800
stealthchop_threshold: 999999



####################################################################################
# HEAT BED


[heater_bed]
heater_pin: PD12
sensor_pin: PF3 # T0
sensor_type: Generic 3950
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
min_temp: 0
max_temp: 110




##############################################################################################################################################
# BL TOUCH

[bltouch]
sensor_pin: ^PA2
control_pin: PA1

x_offset: 28.4
y_offset: 2
z_offset: 1.45
speed: 3.0
# ^ Speed (in mm/s) of the Z axis when probing. The default is 5mm/s.
samples: 2
samples_tolerance: 0.200
sample_retract_dist: 2.0
lift_speed: 6



####################################################################################
# SAFE Z HOME


[safe_z_home]

home_xy_position: 100, 100

speed: 150.0
# ^ Speed at which the toolhead is moved to the safe Z home
#   coordinate. The default is 50 mm/s
z_hop: 20
# ^ Distance (in mm) to lift the Z axis prior to homing. This is
#   applied to any homing command, even if it doesn't home the Z axis.
#   If the Z axis is already homed and the current Z position is less
#   than z_hop, then this will lift the head to a height of z_hop. If
#   the Z axis is not already homed the head is lifted by z_hop.
#   The default is to not implement Z hop.
z_hop_speed: 10.0
# ^ Speed (in mm/s) at which the Z axis is lifted prior to homing. The
#   default is 15 mm/s.





####################################################################################
# BED LEVELING SUPPORT


[bed_mesh]
#   The speed (in mm/s) of non-probing moves during the calibration.
speed: 150
#   The height (in mm) that the head should be commanded to move to just prior to starting a probe operation.
horizontal_move_z: 5
#   Defines the minimum X, Y coordinate of the mesh for rectangular
#   beds. This coordinate is relative to the probe's location. This
#   will be the first point probed, nearest to the origin. This
mesh_min: 62.4, 38  
mesh_max: 192, 194  
#   For rectangular beds, this is a comma separate pair of integer
#   values X, Y defining the number of points to probe along each
#   axis. A single value is also valid, in which case that value will
#   be applied to both axes. Default is 3, 3.
probe_count: 5, 5
#   For rectangular beds, this is a comma separate pair of integer
#   values X, Y defining the number of points to probe along each
#   axis. A single value is also valid, in which case that value will
#   be applied to both axes. Default is 3, 3.
fade_start: 1.0
fade_end: 10.0
#   A comma separated pair of integers X, Y defining the number of
#   points per segment to interpolate in the mesh along each axis. A
#   "segment" can be defined as the space between each probed point.
#   The user may enter a single value which will be applied to both
#   axes. Default is 2, 2.
mesh_pps: 3, 3
#   The interpolation algorithm to use. May be either "lagrange" or
#   "bicubic". This option will not affect 3x3 grids, which are forced
#   to use lagrange sampling. Default is lagrange.
algorithm: bicubic




####################################################################################
# Z TILT


[z_tilt]
z_positions: -57, 100  #  LEFT Z SCREW
    274, 100           # RIGHT Z SCREW
# ^ A list of X, Y coordinates (one per line; subsequent lines
#   indented) describing the location of each bed "pivot point". The
#   "pivot point" is the point where the bed attaches to the given Z
#   stepper. It is described using nozzle coordinates (the X, Y position
#   of the nozzle if it could move directly above the point). The
#   first entry corresponds to stepper_z, the second to stepper_z1,
#   the third to stepper_z2, etc. This parameter must be provided.

points: 30, 110
    160, 110    
# ^ A list of X, Y coordinates (one per line; subsequent lines
#   indented) that should be probed during a Z_TILT_ADJUST command.
#   Specify coordinates of the nozzle and be sure the probe is above
#   the bed at the given nozzle coordinates. This parameter must be
#   provided.

speed: 200
# ^ The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.

horizontal_move_z: 10
# ^ The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.

retries: 3
# ^ Number of times to retry if the probed points aren't within
#   tolerance.

retry_tolerance: 0.01
# ^ If retries are enabled then retry if largest and smallest probed
#   points differ more than retry_tolerance. Note the smallest unit of
#   change here would be a single step. However if you are probing
#   more points than steppers then you will likely have a fixed
#   minimum value for the range of probed points which you can learn
#   by observing command output.



##############################################################################################################################################
# FAN S

# BTT pi fan is configured in the mcu specific config part at the begining of file

####################################################################################
# PART COOLING FAN

[fan]
pin: PC8


####################################################################################
# HOTEND COOLING FAN

[heater_fan hotend_fan]
pin: PE5
heater: extruder
heater_temp: 35














####################################################################################
# Pause Resume functionality


[pause_resume]
recover_velocity: 50.
# ^ When capture/restore is enabled, the speed at which to return to
#   the captured position (in mm/s). Default is 50.0 mm/s.



####################################################################################
# EXCLUDE OBJECT functionality

[exclude_object]





####################################################################################
# START PRINT macro


[gcode_macro START_PRINT] 
gcode: 
      {% set bedtemp = params.BED|int %}
      {% set hotendtemp = params.HOTEND|int %}
      # Use absolute coordinates 
      G90 
      # Home the printer 
      G28 
      # Reset extruder 
      G92 E0
      # Heat the bed and wait
      M190 S{bedtemp}
      
      BED_MESH_PROFILE LOAD=default     
      # Move to wait position 
      G1 X20 Y20 Z50 F4000.0  
      # Set and wait for nozzle to reach temperature 
      M109 S{hotendtemp}
      # Move Z axis up 
      G1 Z2.0 F3000 
      # Move to start position 
      G1 X60 Y10 Z0.28 F5000.0 
      # Draw the first line
      G1 X100 Z0.28 F1500.0 E12.5 
      # Reset extruder 
      G92 E0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 22.730
#*# pid_ki = 0.953
#*# pid_kd = 135.528
